<!DOCTYPE html>
<html lang="en" ng-app>

<head>
    <meta charset="utf-8">
    
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <script src="https://w.soundcloud.com/player/api.js" type="text/javascript"></script>
    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
    <script src="http://connect.soundcloud.com/sdk.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.12/angular.min.js"></script>
    
</head>

<body>
    <title>SurroundSync</title>
    <div class="page">
    <h1><span class="glyphicon glyphicon-music"></span><i> SurroundSync</i><small> Virtual surround sound with a friend.</small></h1>
    <hr>
    
    <ul class="nav nav-pills orange">
      <li class="active"><a href="#">Home</a></li>
      <li><a href="#">Lobby</a></li>
      <li><a href="music.html">Music Room</a></li>
    </ul>

    <div id='messagesDiv' class="name">
    CREATE NEW ROOM:
    <input type='text' id='nameInput' placeholder='Name'>
    </div>
    
    
  
    
    <div id='roomDiv' class="room">
    ENTER A ROOM:
    <input type='text' id='roomInput' placeholder='Room'>
    </div>

  <div class="or">OR</div>
    
    <p></p>

    <div id="player" class="player" align="center">
    <iframe width="100%" height="200" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/60188057&amp;auto_play=false&amp;hide_related=true&amp;visual=false&amp;show_comments=false&amp;sharing=false" id="p">
    </iframe>
    </div>
    
    </div>
    
    <script>
        //SOUNDCLOUD
         //SC.initialize({
         //  client_id: '11d082453cb959a863745680d58d1b71'
         //});
         //var sound = "http://soundcloud.com/forss/sets/soulhack";
         // SC.oEmbed("http://soundcloud.com/forss/sets/soulhack", {color: "ff0066"},  document.getElementById("player"));
         //;

         //   SC.initialize({
         //     client_id: "11d082453cb959a863745680d58d1b71"
         // redirect_uri: "http://example.com/callback.html",
         //SC.stream("/tracks/293", function(sound){
         //sound.play();


         // });

         //var sound;

        var widgetIframe = document.getElementById('p');
        var sound = SC.Widget(widgetIframe);
        var flag = false;
        (function () {


            sound.bind(SC.Widget.Events.READY, function () {

                console.log("READY");

                //sound.setVolume(0);
//REENABLE HERREEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE
                sound.play();//NEED TO REENABLE THIS
                //sound.seekTo(10000);
                //sound.pause();

            });
            
            sound.bind(SC.Widget.Events.PLAY_PROGRESS, function(out)
            {
                if(out.currentPosition > 200 && flag == false)
                {
                    sound.seekTo(200);
                    sound.pause();
                }
                
            });
            
        }());



         // sound.play();
         //sound.setVolume(0);
         //sound.setPosition(2000);
         //sound.pause();
         //FIREBASE
        var myRootRef = new Firebase('https://boiling-fire-1516.firebaseio.com/sync');
        var syncRef = new Firebase('https://boiling-fire-1516.firebaseio.com/sync');
        var offset;
        
                        var offsetRef = new Firebase("https://boiling-fire-1516.firebaseIO.com/.info/serverTimeOffset");
                offsetRef.on("value", function (snap) {
                    offset = snap.val();
                    var estimatedServerTimeMs = new Date().getTime() + offset;
                    var thisTime = new Date().getTime();
                    //console.log(thisTime - estimatedServerTimeMs);
                    //console.log(estimatedServerTimeMs);
                });
         //myRootRef.set('Hello World!');
         // When the user presses enter on the message input, write the message to firebase.
        $('#nameInput').keypress(function (e) {
            if (e.keyCode == 13) {
                //If user hits enter for a new room name.
                myRootRef = new Firebase('https://boiling-fire-1516.firebaseio.com/sync');
                var newSync = myRootRef.push();

                var name = $('#nameInput').val();
                var ready = "Ready";

                //myRootRef.push({name:name, status:ready});
                newSync.set({
                    'name': name,
                    'name-2' : "None",
                    'status': ready,
                    'lag1' : offset,
                    'lag2' : 0
                });
                var div = document.getElementById('ready1');

                div.innerHTML = name + " is ready!";
                $('#nameInput').val('');
                //console.log("success");
                var url = newSync.toString();


                var divUrl = document.getElementById('outputURL');

                var result = url.substring(url.lastIndexOf('/') + 1);
                //myRootRef = new Firebase('https://boiling-fire-1516.firebaseio.com/sync' + result);

                divUrl.innerHTML = "Send this code to your friend: " + result;
            }
        });

        $('#roomInput').keypress(function (e) {
            if (e.keyCode == 13) {
                //If user hits enter for a new room name.
                //var newSync = myRootRef.push();
                var name = $('#roomInput').val();
                syncRef = new Firebase('https://boiling-fire-1516.firebaseio.com/sync/' + name);
                var connected = "Connected"
                var ready = "Ready";

                //myRootRef.push({name:name, status:ready});
                syncRef.update({
                    'name-2': connected,
                    'lag2': offset
                });
                //var div = document.getElementById('ready1');

                //div.innerHTML = name + " is ready!";
                $('#roomInput').val('');
                //console.log("success");
                //var url = newSync.toString();


                //var divUrl = document.getElementById('outputURL');

                //var result = url.substring(url.lastIndexOf('/') + 1);
                //divUrl.innerHTML = "Send this URL to your friend: " + result;
            }
        });

         //Send the url to the friend.  When the friend goes to that url they will be in the same uniqune firebase location as this user.
         //Fire back to this user once the other user hits enter and set to play. SIMPLE.
         //FIREBASE READ
        myRootRef.on('child_changed', function (snapshot) {
            if (snapshot.val() === null) {
                // console.log("user is not ready");
            } else {
                //switch the time offsets?
                    var myOffset = offset;
                    
                    var lag1 = snapshot.val().lag1;
                    var lag2 = snapshot.val().lag2;
                    var diff = lag1 - lag2;
                    
                    if (myOffset == lag1)
                    {
                        myOffset = lag2 * -1;
                    }
                    else myOffset = lag1 * -1;

                    //setTimeout(function(){alert("hi")}, 1000);
                    //if (diff <= 100 && diff >= -100)
                    //{
                    if(diff < 0)
                        diff = diff *-1;
                        
                        //sound.seekTo(diff);
                        
                        setTimeout(playMusic(), diff);
                    //}
                    //else alert("Your latency is too high.")
                        
                    console.log("Playing from " + diff);
                    
                    
                    //sound.seekTo(offset * -1);
                    //sound.setVolume(0);
                    //sound.seekTo(Math.round((offset * -1)/2));
                    // sound.setVolume(100);
                    //console.log(Math.round((offset * -1) / 2));



                }
                // var nname = snapshot.val();
                // //var sstatus = snapshot.val().status;
                // console.log('User ' + nname.name + ' ' + 'is ready');

                //sound.seekTo
                //sound.play();

            
        });
function playMusic()
{
    
    flag = true;
                        sound.play();
}
        
    
    </script>

    <div id="ready1"></div>
    <br>
    <div id="outputURL"></div>


</body>

</html>


